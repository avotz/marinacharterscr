wc_bookings_date_picker={},jQuery(function(t){var e=window.navigator.userLanguage||window.navigator.language,a=0,i={init:function(){t("body").on("click",".wc-bookings-date-picker legend small.wc-bookings-date-picker-choose-date",this.toggle_calendar),t("body").on("click",".booking_date_year, .booking_date_month, .booking_date_day",this.open_calendar),t("body").on("input",".booking_date_year, .booking_date_month, .booking_date_day",this.input_date_trigger),t("body").on("keypress",".booking_date_year, .booking_date_month, .booking_date_day",this.input_date_keypress),t("body").on("keypress",".booking_to_date_year, .booking_to_date_month, .booking_to_date_day",this.input_date_keypress),t("body").on("change",".booking_to_date_year, .booking_to_date_month, .booking_to_date_day",this.input_date_trigger),t(".wc-bookings-date-picker legend small.wc-bookings-date-picker-choose-date").show(),t(".wc-bookings-date-picker").each(function(){var e=t(this).closest("form"),a=e.find(".picker"),i=t(this).closest("fieldset");wc_bookings_date_picker.date_picker_init(a),"always_visible"==a.data("display")?(t(".wc-bookings-date-picker-date-fields",i).hide(),t(".wc-bookings-date-picker-choose-date",i).hide()):a.hide(),a.data("is_range_picker_enabled")&&(e.find("p.wc_bookings_field_duration").hide(),e.find(".wc_bookings_field_start_date legend span.label").text("always_visible"!==a.data("display")?booking_form_params.i18n_dates:booking_form_params.i18n_start_date))})},calc_duration:function(t){var e=t.closest("form"),a=t.closest("fieldset"),i=t.data("duration-unit");setTimeout(function(){var t=1,o=parseInt(a.find("input.booking_to_date_year").val(),10),s=parseInt(a.find("input.booking_to_date_month").val(),10),n=parseInt(a.find("input.booking_to_date_day").val(),10),_=parseInt(a.find("input.booking_date_year").val(),10),r=parseInt(a.find("input.booking_date_month").val(),10),d=parseInt(a.find("input.booking_date_day").val(),10);if(o&&s>=0&&n&&_&&r>=0&&d){var l=new Date(Date.UTC(_,r-1,d)),c=new Date(Date.UTC(o,s-1,n));t=Math.floor((c.getTime()-l.getTime())/864e5),"day"===i&&(t+=1)}e.find("#wc_bookings_field_duration").val(t).change()})},open_calendar:function(){$picker=t(this).closest("fieldset").find(".picker:eq(0)"),wc_bookings_date_picker.date_picker_init($picker),$picker.slideDown()},toggle_calendar:function(){$picker=t(this).closest("fieldset").find(".picker:eq(0)"),wc_bookings_date_picker.date_picker_init($picker),$picker.slideToggle()},input_date_keypress:function(){var e=t(this).closest("fieldset").find(".picker:eq(0)");e.data("is_range_picker_enabled")&&(clearTimeout(a),a=setTimeout(wc_bookings_date_picker.calc_duration(e),800))},input_date_trigger:function(){var e=t(this).closest("fieldset"),a=e.find(".picker:eq(0)"),i=(t(this).closest("form"),parseInt(e.find("input.booking_date_year").val(),10)),o=parseInt(e.find("input.booking_date_month").val(),10),s=parseInt(e.find("input.booking_date_day").val(),10);if(i&&o&&s){var n=new Date(i,o-1,s);if(a.datepicker("setDate",n),a.data("is_range_picker_enabled")){var _=parseInt(e.find("input.booking_to_date_year").val(),10),r=parseInt(e.find("input.booking_to_date_month").val(),10),d=parseInt(e.find("input.booking_to_date_day").val(),10),l=new Date(_,r-1,d);!l||l<n?(e.find("input.booking_to_date_year").val("").addClass("error"),e.find("input.booking_to_date_month").val("").addClass("error"),e.find("input.booking_to_date_day").val("").addClass("error")):e.find("input").removeClass("error")}e.triggerHandler("date-selected",n)}},select_date_trigger:function(e){var a=t(this).closest("fieldset"),i=a.find(".picker:eq(0)"),o=t(this).closest("form"),s=e.split("-"),n=i.data("start_or_end_date");i.data("is_range_picker_enabled")&&n||(n="start"),"end"===n?(i.data("min_date",i.data("o_min_date")),a.find("input.booking_to_date_year").val(s[0]),a.find("input.booking_to_date_month").val(s[1]),a.find("input.booking_to_date_day").val(s[2]).change(),i.data("is_range_picker_enabled")&&wc_bookings_date_picker.calc_duration(i),i.data("start_or_end_date","start"),i.data("is_range_picker_enabled")&&o.find(".wc_bookings_field_start_date legend span.label").text("always_visible"!==i.data("display")?booking_form_params.i18n_dates:booking_form_params.i18n_clear_date_selection),"always_visible"!==i.data("display")&&t(this).hide()):(i.data("is_range_picker_enabled")&&(i.data("o_min_date",i.data("min_date")),i.data("min_date",e)),a.find("input.booking_to_date_year").val(""),a.find("input.booking_to_date_month").val(""),a.find("input.booking_to_date_day").val(""),a.find("input.booking_date_year").val(s[0]),a.find("input.booking_date_month").val(s[1]),a.find("input.booking_date_day").val(s[2]).change(),i.data("is_range_picker_enabled")&&wc_bookings_date_picker.calc_duration(i),i.data("start_or_end_date","end"),i.data("is_range_picker_enabled")&&o.find(".wc_bookings_field_start_date legend span.label").text(booking_form_params.i18n_end_date),"always_visible"===i.data("display")||i.data("is_range_picker_enabled")||t(this).hide()),a.triggerHandler("date-selected",e,n)},date_picker_init:function(t){var e=new o(t);e.set_default_params({onSelect:wc_bookings_date_picker.select_date_trigger,minDate:e.get_data_attr("min_date"),maxDate:e.get_data_attr("max_date"),defaultDate:e.get_data_attr("default_date"),closeText:e.get_custom_data("closeText"),currentText:e.get_custom_data("currentText"),prevText:e.get_custom_data("prevText"),nextText:e.get_custom_data("nextText"),monthNames:e.get_custom_data("monthNames"),monthNamesShort:e.get_custom_data("monthNamesShort"),dayNames:e.get_custom_data("dayNames"),dayNamesShort:e.get_custom_data("dayNamesShort"),dayNamesMin:e.get_custom_data("dayNamesMin"),firstDay:booking_form_params.client_firstday?moment().localeData().firstDayOfWeek():e.get_custom_data("firstDay"),isRTL:e.get_custom_data("isRTL"),beforeShowDay:e.maybe_load_from_cache.bind(e),onChangeMonthYear:function(t,e){this.get_data(t,e).done(this.applyStylesToDates)}.bind(e)}),e.create()},refresh_datepicker:function(){t(".wc-bookings-date-picker").find(".picker:eq(0)").datepicker("refresh")},get_input_date:function(t,e){var a=t.find("input.booking_"+e+"date_year"),i=t.find("input.booking_"+e+"date_month"),o=t.find("input.booking_"+e+"date_day");return 0!==a.val().length&&0!==i.val().length&&0!==o.val().length?a.val()+"-"+i.val()+"-"+o.val():""},get_number_of_days:function(t,e,a,i){var o=t,s=i;e.find("#wc_bookings_field_duration").length>0&&"minute"!=s.duration_unit&&"hour"!=s.duration_unit&&!a.data("is_range_picker_enabled")&&(o*=e.find("#wc_bookings_field_duration").val());return(o<1||"start"===s.check_availability_against)&&(o=1),o},is_blocks_bookable:function(e){for(var a=e.default_availability,i=0;i<e.number_of_days;i++){var o=new Date(e.start_date);o.setDate(o.getDate()+i);var s=o.getFullYear(),n=o.getMonth()+1,_=o.getDate(),r=o.getDay();t.datepicker.iso8601Week(o);0===r&&(r=7);var d={date:o,default_availability:e.default_availability},l=e.availability[e.resource_id];if(a=wc_bookings_date_picker.is_resource_available_on_date(d,l),"automatic"===e.resources_assignment){var c=t.extend({availability:e.availability,fully_booked_days:e.fully_booked_days},d);a=wc_bookings_date_picker.has_available_resource(c)}var u=s+"-"+n+"-"+_;if(e.fully_booked_days[u]&&(e.fully_booked_days[u][0]||e.fully_booked_days[u][e.resource_id])&&(a=!1),!a)break}return a},is_resource_available_on_date:function(e,a){if("object"!=typeof e||"object"!=typeof a)return!1;var i=e.default_availability,o=e.date.getFullYear(),s=e.date.getMonth()+1,n=e.date.getDate(),r=e.date.getDay(),d=new Date(o,0,1),l=Math.ceil(((e.date-d)/864e5+d.getDay()+1)/7);if(0===r&&(r=7),e.fully_booked_days&&e.fully_booked_days[o+"-"+s+"-"+n]&&e.fully_booked_days[o+"-"+s+"-"+n][e.resource_id])return!1;var c=[],u=_.range(1,1440,1);return i&&(c=u),t.each(a,function(t,e){var a=e.type,i=e.range;try{switch(a){case"months":if(void 0!==i[s])return c=i[s]?u:[],!0;break;case"weeks":if(void 0!==i[l])return c=i[l]?u:[],!0;break;case"days":if(void 0!==i[r])return c=i[r]?u:[],!0;break;case"custom":if(void 0!==i[o][s][n])return c=i[o][s][n]?u:[],!0;break;case"time":case"time:1":case"time:2":case"time:3":case"time:4":case"time:5":case"time:6":case"time:7":if(r===i.day||0===i.day){var d=parseInt(i.from.split(":")[0]),b=parseInt(i.from.split(":")[1]),g=parseInt(i.to.split(":")[0]),k=b+60*d,p=parseInt(i.to.split(":")[1])+60*g,f=_.range(k,p,1);return c=i.rule?_.union(c,f):_.difference(c,f),!0}break;case"time:range":i=i[o][s][n];d=parseInt(i.from.split(":")[0]),b=parseInt(i.from.split(":")[1]),g=parseInt(i.to.split(":")[0]),k=b+60*d,p=parseInt(i.to.split(":")[1])+60*g,f=_.range(k,p,1);c=i.rule?_.union(c,f):_.difference(c,f)}}catch(t){return!0}}),!_.isEmpty(c)},get_week_number:function(t){var e=new Date(t.getFullYear(),0,1);return Math.ceil(((t-e)/864e5+e.getDay()+1)/7)},has_available_resource:function(t){for(var e in t.availability)if(0!==(e=parseInt(e,10))){var a=t.availability[e];if(t.resource_id=e,wc_bookings_date_picker.is_resource_available_on_date(t,a))return!0}return!1}},o=function(e){this.$picker=t(e),this.$form=this.$picker.closest("form"),this.customData={},this.opts={cache:!1},this.cache={data:{},attributes:{}},t.each(wc_bookings_booking_form,function(t,e){this.customData[t]=e}.bind(this)),t.each(booking_form_params,function(t,e){this.customData[t]=e}.bind(this)),!this.customData.cache_ajax_requests||"true"!=this.customData.cache_ajax_requests.toLowerCase()&&"false"!=this.customData.cache_ajax_requests.toLowerCase()||(this.opts.cache="true"==this.customData.cache_ajax_requests.toLowerCase()),this.$picker.length};o.prototype.create=function(){var e=parseInt(this.$form.find("input.booking_date_year").val(),10),a=parseInt(this.$form.find("input.booking_date_month").val(),10),i=parseInt(this.$form.find("input.booking_date_day").val(),10);this.$picker.empty().removeClass("hasDatepicker").datepicker(this.get_default_params()),t(".ui-datepicker-current-day").removeClass("ui-datepicker-current-day"),e&&a&&i&&this.$picker.datepicker("setDate",new Date(e,a-1,i));var o=this.$picker.datepicker("getDate").getMonth()+1,s=this.$picker.datepicker("getDate").getFullYear();this.get_data(s,o).done(this.applyStylesToDates)},o.prototype.applyStylesToDates=function(e){e.startDate.setHours(12),e.endDate.setHours(12);for(var a=e.startDate;a<e.endDate;){var i=a.getTime();if(!this.cache.attributes[i]){var o=this.getDateElementAttributes(a),s=t('td[data-month="'+a.getMonth()+'"] a',this.$picker).filter(function(){return t(this).text()==a.getDate()}).parent();o.selectable||(o.class.push("ui-datepicker-unselectable"),o.class.push("ui-state-disabled")),a.setHours(12,0,0,0)===(new Date).setHours(12,0,0,0)&&o.class.push("ui-datepicker-today"),t.each(o,function(e,a){s.attr(e,t.isArray(a)?a.join(" "):a)}),this.opts.cache&&(this.cache.attributes[i]=o)}a.setDate(a.getDate()+1)}},o.prototype.maybe_load_from_cache=function(t){var e=t.getTime(),a=[!0,"1"===this.customData.default_availability?"bookable":"not-bookable",""],i=this.cache.attributes[e];if(i)i=[i.selectable,i.class.join(" "),i.title];else if(this.bookingsData){var o=this.getDateElementAttributes(t);a=[o.selectable,o.class.join(" "),o.title]}return i||a},o.prototype.get_default_params=function(){return this.defaultParams||{}},o.prototype.set_default_params=function(e){var a={showWeek:!1,showOn:!1,numberOfMonths:1,showButtonPanel:!1,showOtherMonths:!0,selectOtherMonths:!0,gotoCurrent:!0,dateFormat:t.datepicker.ISO_8601};if("object"!=typeof e)throw new Error("Cannot set params with typeof "+typeof e);this.defaultParams=t.extend(a,e)||{}},o.prototype.get_data=function(e,a){var i=function(t){t||(t=new Date([e,a,"01"].join("/")));var i=this.get_number_of_days_in_month(a);return this.get_padded_date_range(t,i)}.bind(this),o=t.Deferred(),s=i(),n=s.startDate.getTime()+"-"+s.endDate.getTime();if(this.opts.cache&&this.cache.data[n])o.resolveWith(this,[s,this.cache.data[n]]);else{var _={product_id:this.get_custom_data("product_id"),"wc-ajax":"wc_bookings_find_booked_day_blocks",security:this.$form.data("nonce")};this.$picker.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),booking_form_params.timezone_conversion&&(_.timezone_offset=get_client_server_timezone_offset_hrs(s.startDate)),_.min_date=moment(s.startDate).format("YYYY-MM-DD"),_.max_date=moment(s.endDate).format("YYYY-MM-DD"),t.ajax({context:this,url:wc_bookings_date_picker_args.ajax_url,method:"GET",data:_}).done(function(_){this.bookingsData=this.bookingsDate||{},t.each(_,function(e,a){if(t.isArray(a)||"object"==typeof a){var i=t.isArray(a)?[]:{};this.bookingsData[e]=this.bookingsData[e]||i,t.extend(this.bookingsData[e],a)}else this.bookingsData[e]=a}.bind(this)),this.cache.data[n]=_,e||a||!this.bookingsData.min_date||(s=i(this.get_default_date(this.bookingsData.min_date))),o.resolveWith(this,[s,_]),this.$picker.unblock()}.bind(this))}return o},o.prototype.get_default_date=function(t){var e,a=this.$picker.data("default_date").split("-");a[2]="31";var i=1;if(e=3!==a.length?new Date:new Date(a),t){switch(t.unit){case"month":i=30;break;case"week":i=7}i*=t.value,e.setDate(e.getDate()+i)}return e},o.prototype.get_number_of_days_in_month=function(t){var e=this.get_default_date();return t=t||e.getMonth()+1,new Date(e.getFullYear(),t,0).getDate()},o.prototype.get_custom_data=function(t){if(t)return this.customData[t]||null},o.prototype.get_data_attr=function(t){if(t)return this.$picker.data(t)},o.prototype.get_padded_date_range=function(t,e,a){t=t||this.get_default_date(),e=e||30,a=a||7;var i=new Date,o=t<i,s=new Date(t.setDate(o?i.getDate():"01")),n=new Date(s.getTime());return s.setDate(s.getDate()-(o?0:a)),n.setDate(n.getDate()+(e+a)),{startDate:s,endDate:n}},o.prototype.getDateElementAttributes=function(e){var a={class:[],title:"",selectable:!0},i=this.$form.find("select#wc_bookings_field_resource").val()>0?this.$form.find("select#wc_bookings_field_resource").val():0,o=e.getFullYear(),s=e.getMonth()+1,n=e.getDate(),_=e.getDay(),r=o+"-"+s+"-"+n;new Date;if(this.bookingsData.unavailable_days&&this.bookingsData.unavailable_days[r]&&this.bookingsData.unavailable_days[r][i]&&(a.title=booking_form_params.i18n_date_unavailable,a.selectable=!1,a.class.push("not_bookable")),this.bookingsData.buffer_days&&this.bookingsData.buffer_days[r]&&(a.title=booking_form_params.i18n_date_unavailable,a.selectable=!1,a.class.push("not_bookable")),this.bookingsData.restricted_days&&void 0===this.bookingsData.restricted_days[_]&&(a.title=booking_form_params.i18n_date_unavailable,a.selectable=!1,a.class.push("not_bookable")),""+o+s+n<wc_bookings_booking_form.current_time&&(a.title=booking_form_params.i18n_date_unavailable,a.selectable=!1,a.class.push("not_bookable")),this.bookingsData.fully_booked_days[r]){if(this.bookingsData.fully_booked_days[r][0]||this.bookingsData.fully_booked_days[r][i])return a.title=booking_form_params.i18n_date_fully_booked,a.selectable=!1,a.class=["fully_booked"],a;"automatic"===this.customData.resources_assignment&&(a.class=["partial_booked"])}this.bookingsData.partially_booked_days&&this.bookingsData.partially_booked_days[r]&&("automatic"===this.customData.resources_assignment||this.bookingsData.partially_booked_days[r][0]||this.bookingsData.partially_booked_days[r][i])&&(a.class=["partial_booked"]);var d=wc_bookings_date_picker.get_number_of_days(this.customData.booking_duration,this.$form,this.$picker,wc_bookings_booking_form),l={start_date:e,number_of_days:d,fully_booked_days:this.bookingsData.fully_booked_days,availability:this.bookingsData.availability_rules,default_availability:this.customData.default_availability,resource_id:i,resources_assignment:this.customData.resources_assignment},c=wc_bookings_date_picker.is_blocks_bookable(l);if(c){a.class.indexOf("partial_booked")>-1?a.title=booking_form_params.i18n_date_partially_booked:a.title=booking_form_params.i18n_date_available;var u,b=this.$picker.closest("fieldset"),g=t.datepicker.parseDate(t.datepicker.ISO_8601,wc_bookings_date_picker.get_input_date(b,""));this.$picker.data("is_range_picker_enabled")?u=t.datepicker.parseDate(t.datepicker.ISO_8601,wc_bookings_date_picker.get_input_date(b,"to_")):g&&d>1&&(u=new Date(g)).setDate(u.getDate()+(d-1)),g&&(e.getTime()===g.getTime()||u&&e>=g&&e<=u)?(a.class.push("bookable-range"),e.getTime()===g.getTime()?a.class.push("selection-start-date"):e.getTime()===u.getTime()&&a.class.push("selection-end-date")):a.class.push("bookable")}else a.title=booking_form_params.i18n_date_unavailable,a.selectable=c,a.class=[this.bookingsData.fully_booked_days[r]?"fully_booked":"not_bookable"];return a},moment.locale(e),wc_bookings_date_picker=i,wc_bookings_date_picker.init()});
